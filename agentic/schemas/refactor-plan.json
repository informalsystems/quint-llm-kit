{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Refactor Plan",
  "description": "Detailed plan for refactoring Quint specifications",
  "type": "object",
  "required": ["objective", "modules", "validation_plan"],
  "properties": {
    "objective": {
      "type": "string",
      "description": "What this refactor aims to achieve"
    },
    "modules": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["name", "changes"],
        "properties": {
          "name": {"type": "string"},
          "changes": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["item", "name", "change", "details"],
              "properties": {
                "item": {
                  "type": "string",
                  "enum": ["type", "constant", "state", "pure_def", "action", "invariant", "test"]
                },
                "name": {"type": "string"},
                "change": {
                  "type": "string",
                  "enum": ["add", "modify", "remove"]
                },
                "details": {"type": "string"},
                "line_ref": {"type": "integer"}
              }
            }
          },
          "notes": {"type": "string"}
        }
      }
    },
    "patterns_to_apply": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["pattern_id", "reason"],
        "properties": {
          "pattern_id": {"type": "string"},
          "reason": {"type": "string"},
          "modules": {
            "type": "array",
            "items": {"type": "string"}
          }
        }
      }
    },
    "validation_plan": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["command", "purpose"],
        "properties": {
          "command": {"type": "string"},
          "purpose": {"type": "string"},
          "expected_outcome": {"type": "string"}
        }
      }
    },
    "risks": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "description": {"type": "string"},
          "severity": {
            "type": "string",
            "enum": ["high", "medium", "low"]
          },
          "mitigation": {"type": "string"}
        }
      }
    },
    "open_questions": {
      "type": "array",
      "items": {"type": "string"},
      "description": "Unresolved questions that may affect implementation"
    },
    "approval": {
      "type": "object",
      "description": "User approval metadata (added after user approves plan)",
      "properties": {
        "approved": {
          "type": "boolean",
          "description": "Whether the plan was approved by user"
        },
        "approved_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO-8601 timestamp of approval"
        },
        "approved_by": {
          "type": "string",
          "description": "User identifier (e.g., 'user', username, email)"
        },
        "decision": {
          "type": "string",
          "enum": ["approved", "rejected", "edited", "saved"],
          "description": "User's decision on the plan"
        },
        "notes": {
          "type": "string",
          "description": "Optional notes from user about approval decision"
        }
      }
    }
  }
}
