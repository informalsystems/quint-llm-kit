# Refactor Plan Display Template

This template is used by the analyzer agent to display refactor plans for user approval.

## Template Structure

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Refactor Plan: {objective}                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ Objective
{objective_description}

ğŸ¯ Modules Affected: {module_count}

{for each module}
â”Œâ”€ Module: {module_name} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
{if has additions}
â”‚ â• ADD ({add_count} items)                              â”‚
{for each addition}
â”‚   â€¢ {item_type}: {item_name}                            â”‚
â”‚     {details}                                           â”‚
â”‚     {if line_ref}(line {line_ref}){endif}               â”‚
â”‚                                                         â”‚
{endfor}
{endif}
â”‚                                                         â”‚
{if has modifications}
â”‚ âœï¸  MODIFY ({modify_count} items)                       â”‚
{for each modification}
â”‚   â€¢ {item_type}: {item_name} (line {line_ref})          â”‚
â”‚     {details}                                           â”‚
â”‚                                                         â”‚
{endfor}
{endif}
â”‚                                                         â”‚
{if has removals}
â”‚ â– REMOVE ({remove_count} items)                        â”‚
{for each removal}
â”‚   â€¢ {item_type}: {item_name} (line {line_ref})          â”‚
â”‚     {details}                                           â”‚
â”‚                                                         â”‚
{endfor}
{endif}
{if has notes}
â”‚ ğŸ“ Notes: {notes}                                       â”‚
â”‚                                                         â”‚
{endif}
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

{endfor}

{if has patterns}
ğŸ¨ Patterns to Apply ({pattern_count})
{for each pattern}
  â€¢ {pattern_id}: {reason}
    {if modules}Applies to: {module_list}{endif}
{endfor}
{endif}

âœ… Validation Plan ({validation_count} checks)
{for each validation with index}
  {index}. {command_short}
     Purpose: {purpose}
     {if expected_outcome}Expected: {expected_outcome}{endif}
{endfor}

{if has risks}
âš ï¸  Risks ({risk_count})
{for each risk}
  â€¢ [{severity}] {description}
    {if mitigation}Mitigation: {mitigation}{endif}
{endfor}
{endif}

{if has open_questions}
â“ Open Questions
{for each question}
  â€¢ {question}
{endfor}
{endif}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Do you approve this refactor plan?

  [1] âœ“ Approve and proceed
      Continue to implementation phase

  [2] âœ— Reject and cancel
      Stop refactoring, no changes made

  [3] âœ Edit plan manually
      Open plan in editor for adjustments

  [4] ğŸ’¾ Save plan and decide later
      Write plan to file, exit gracefully

Your choice [1-4]:
```

## Variables Reference

### Top Level
- `{objective}`: Short title (truncated to 50 chars)
- `{objective_description}`: Full objective text
- `{module_count}`: Number of modules affected

### Module Level
- `{module_name}`: Name of the module
- `{add_count}`: Number of additions
- `{modify_count}`: Number of modifications
- `{remove_count}`: Number of removals
- `{notes}`: Optional module notes

### Change Item
- `{item_type}`: type, constant, state, pure_def, action, invariant, test
- `{item_name}`: Name of the item
- `{details}`: Description of the change
- `{line_ref}`: Line number (optional)

### Patterns
- `{pattern_count}`: Number of patterns
- `{pattern_id}`: Pattern identifier
- `{reason}`: Why this pattern applies
- `{module_list}`: Comma-separated module names

### Validation
- `{index}`: 1-based index
- `{command_short}`: Shortened command (e.g., "quint typecheck")
- `{purpose}`: What this validation checks
- `{expected_outcome}`: Expected result

### Risks
- `{risk_count}`: Number of risks
- `{severity}`: HIGH, MEDIUM, LOW
- `{description}`: Risk description
- `{mitigation}`: Optional mitigation strategy

### Questions
- `{question}`: Open question text

## Formatting Rules

1. **Truncation:**
   - Objective title: max 50 chars, append "..." if longer
   - Details: max 80 chars per line, wrap if needed

2. **Counters:**
   - Only show sections with count > 0
   - Show "0 items" if explicitly needed

3. **Line References:**
   - Show "(line X)" for modifications and removals
   - Optional for additions (usually no line ref)

4. **Colors (if terminal supports):**
   - â• ADD: Green
   - âœï¸  MODIFY: Yellow
   - â– REMOVE: Red
   - âš ï¸  Risks: Yellow
   - âœ“ Approve: Green
   - âœ— Reject: Red

5. **Box Drawing:**
   - Header: â•”â•â•â•— (double line)
   - Modules: â”Œâ”€â”€â” (single line)
   - Separator: â”€â”€â”€ (em dash)

## Example Output

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Refactor Plan: Add timeout mechanism                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ Objective
Add timeout mechanism to enable round progression when
consensus stalls due to lack of proposals or votes.

ğŸ¯ Modules Affected: 1

â”Œâ”€ Module: Consensus â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚ â• ADD (3 items)                                        â”‚
â”‚   â€¢ type: TimeoutEvent                                  â”‚
â”‚     Union type for ProposeTimeout | PrevoteTimeout |    â”‚
â”‚     PrecommitTimeout                                    â”‚
â”‚                                                         â”‚
â”‚   â€¢ state: timeouts                                     â”‚
â”‚     Map from node ID to set of pending timeout events   â”‚
â”‚                                                         â”‚
â”‚   â€¢ action: handleTimeout                               â”‚
â”‚     Process timeout event and advance round if          â”‚
â”‚     applicable                                          â”‚
â”‚                                                         â”‚
â”‚ âœï¸  MODIFY (1 item)                                     â”‚
â”‚   â€¢ action: step (line 100)                             â”‚
â”‚     Include handleTimeout in step action choices        â”‚
â”‚                                                         â”‚
â”‚ ğŸ“ Notes: Ensure timeout handling preserves agreement   â”‚
â”‚           invariant                                     â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¨ Patterns to Apply (1)
  â€¢ thin-actions: Keep handleTimeout logic in pure functions
    Applies to: Consensus

âœ… Validation Plan (3 checks)
  1. quint parse specs/consensus.qnt
     Purpose: Verify syntax correctness
  2. quint typecheck specs/consensus.qnt
     Purpose: Ensure type safety
     Expected: All types valid
  3. quint run --invariant=agreement --max-steps=100
     Purpose: Verify agreement preserved after timeout changes
     Expected: Invariant satisfied

âš ï¸  Risks (1)
  â€¢ [MEDIUM] Timeout timing assumptions may not hold in all
    network conditions

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Do you approve this refactor plan?

  [1] âœ“ Approve and proceed
      Continue to implementation phase

  [2] âœ— Reject and cancel
      Stop refactoring, no changes made

  [3] âœ Edit plan manually
      Open plan in editor for adjustments

  [4] ğŸ’¾ Save plan and decide later
      Write plan to file, exit gracefully

Your choice [1-4]:
```
