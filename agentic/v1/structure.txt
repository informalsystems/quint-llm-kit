Quint Specification Workflow v3.0 - Directory Structure
========================================================

v3/
│
├── README.md                          # Architecture overview, v3 enhancements
├── structure.txt                      # This file - directory structure reference
│
├── agents/                            # 3 HIGH-LEVEL ORCHESTRATORS
│   ├── analyzer.md                    # Requirements → Planning artifacts + approval
│   ├── implementer.md                 # Planning → Refactored specs + validation
│   └── verifier.md                    # Specs → Verification report + classification
│
├── commands/                          # 9 ATOMIC OPERATIONS
│   │
│   ├── spec/                          # Specification analysis (1 command)
│   │   └── analyze.md                 # Extract structure, AST, dependencies
│   │
│   ├── refactor/                      # Refactoring operations (4 commands)
│   │   ├── plan.md                    # Design change strategy
│   │   ├── prepare.md                 # Initialize workspace
│   │   ├── apply.md                   # Execute changes on module (references guidelines)
│   │   └── validate.md                # Run Quint CLI validation
│   │
│   └── verify/                        # Verification operations (4 commands)
│       ├── detect-framework.md        # Identify standard vs choreo
│       ├── design-tests.md            # Generate witnesses, invariants, tests
│       ├── execute.md                 # Run verification suite
│       └── classify.md                # Analyze results, generate report
│
├── guidelines/                        # DETAILED REFERENCE MATERIALS
│   ├── README.md                      # Guidelines architecture documentation
│   ├── planning.md                    # Plan quality evaluation (for analyzer)
│   ├── implementation.md              # Implementation strategies (for refactor/apply)
│   ├── iteration.md                   # Validation failure handling (for implementer)
│   └── verification.md                # Verification procedures (for verifier)
│
├── schemas/                           # 4 JSON CONTRACTS
│   ├── requirement-analysis.json      # Requirement parsing output
│   ├── spec-structure.json            # Spec structure metadata
│   ├── refactor-plan.json             # Refactoring plan (includes approval metadata)
│   └── verification-report.json       # Verification results
│
└── templates/                         # OUTPUT TEMPLATES
    └── refactor-plan-display.txt      # User-facing plan presentation format

Key Principles
==============

1. SEPARATION: Agents orchestrate, Commands execute
2. GUIDELINES: Detailed reference materials separate from agent prompts
3. CONTRACTS: All artifacts have JSON schemas
4. ATOMIC: Each command does ONE thing well
5. APPROVAL: User reviews plans before implementation
6. ITERATION: 3-attempt loops for error recovery
7. SELF-EVALUATION: Agents check their own work quality
8. TRACEABLE: Requirements → Changes → Tests → Results

V3 Enhancements Over V2
=======================

1. **Guidelines Architecture**
   - Agents reference detailed materials without loading them
   - Reduces agent prompt size by 54-82%
   - Easier maintenance and updates

2. **Plan Approval Workflow**
   - User reviews refactor plan before implementation
   - Approval metadata tracked in refactor-plan.json
   - Implementer verifies approval before proceeding

3. **Self-Evaluation**
   - Agents use checklists to verify quality
   - Guidelines provide evaluation procedures
   - Iteration strategies for quality improvement

4. **Enhanced Error Recovery**
   - Detailed diagnosis procedures in guidelines
   - Error categorization tables
   - Targeted fix strategies

Workflow
========

Full Pipeline:
  analyzer → [user approval] → implementer → verifier

Verify Only:
  verifier (standalone)

Iterative:
  analyzer → [user approval] → implementer → verifier → (loop on failures)

Agents Call Commands
====================

analyzer:
  ├─> /spec/analyze
  ├─> /refactor/plan
  └─> [WAIT FOR USER APPROVAL]

implementer:
  ├─> Verify plan approval
  ├─> /refactor/prepare
  ├─> /refactor/apply (per module, uses guidelines/implementation.md)
  └─> /refactor/validate (uses guidelines/iteration.md on failure)

verifier:
  ├─> /verify/detect-framework
  ├─> /verify/design-tests
  ├─> /verify/execute (uses guidelines/verification.md)
  └─> /verify/classify

Guidelines Usage by Agents
===========================

analyzer:
  └─> guidelines/planning.md (Phase 4: Plan Quality Self-Evaluation)

implementer:
  └─> guidelines/iteration.md (Phase 4-5: Validation and Quality Assurance)

refactor/apply:
  └─> guidelines/implementation.md (Phase 2: Apply Changes)

verifier:
  └─> guidelines/verification.md (Phase 3: Execute Verification)

Artifacts Flow
==============

User Requirement
  ↓
analyzer
  ├─> requirement-analysis.json
  ├─> spec-structure.json
  └─> refactor-plan.json (with approval: false)
  ↓
[USER REVIEWS PLAN]
  ↓
refactor-plan.json (updated with approval: true)
  ↓
implementer
  ├─> Checks approval metadata
  ├─> refactored/*.qnt
  └─> validation-results.json
  ↓
verifier
  ├─> *_test.qnt
  └─> verification-report.json

MCP Integration
===============

Agents use MCP servers directly:
- quint-kb: Search docs, patterns, examples
- quint-lsp: Extract symbols, references

No separate research-agent wrapper needed.

Version Info
============

v3.0.0 - Guidelines architecture + approval workflow (this version)
v2.0.0 - Streamlined architecture
v1.0.0 - Original

File Count: 24 files (3 agents + 9 commands + 4 schemas + 5 guidelines + 1 template + 2 docs)
Lines: ~3500 total
  - Agent prompts: ~700 lines (reduced from ~1400 in v2)
  - Guidelines: ~1600 lines (extracted from agents)
  - Commands: ~900 lines
  - Documentation: ~300 lines
Duplication: Minimal (unified, DRY)
